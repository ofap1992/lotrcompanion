<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOTR Journey Companion</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { margin: 0; background-color: #161310; color: #d4c3a1; font-family: "Georgia", serif; }
        * { box-sizing: border-box; }
        input[type=range] { cursor: pointer; accent-color: #c1a45d; }
        .nav-bar { display: flex; justify-content: space-between; align-items: center; background-color: #1e1a15; padding: 10px 15px; border: 1px solid #3d3329; border-radius: 4px; margin-bottom: 10px; }
        .nav-bar select { background-color: #161310; color: #c1a45d; border: 1px solid #3d3329; padding: 5px; font-family: "Georgia", serif; border-radius: 4px; width: 75%; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // =========================================================
        // 1. EDITABLE CONTENT AREA
        // =========================================================
        const CHAPTER_DATA = {
            bookTitle: "THE FELLOWSHIP OF THE RING",
            departureDate: "September 23",
            currentChapter: {
                number: 2,
                title: "THE SHADOW OF THE PAST",
                location: "Hobbiton (Bag End)",
                currentDate: "September 22",
                // SNAP TO THESE COORDS
                coords: { x: 18.2, y: 22.5 }, 
                illustrations: [
                    { url: "https://i.imgur.com/GBSMRsK.jpeg", label: "Bag End" },
                    { url: "https://i.imgur.com/yQEGPTw.jpeg", label: "Gandalf the Grey" },
                    { url: "https://i.imgur.com/h0kIwMT.jpeg", label: "Fireworks at Bilbo's party" },
                    { url: "https://i.imgur.com/ixBz7nb.jpeg", label: "Frodo and Gandalf discuss the Ring" },
                    { url: "https://i.imgur.com/nzlwhCp.jpeg", label: "The Ring" }
                ],
                videos: [
                    { id: "9B6dsfGazyI", label: "Roads Go Ever On - Clamavi De Profundis" },
                    { id: "CL_3mlOPnGI", label: "Concerning Hobbits - Howard Shore" }
                ]
            }
        };

        // =========================================================
        // 2. TECHNICAL ENGINE
        // =========================================================
        const LOTRCompanion = () => {
            const data = CHAPTER_DATA.currentChapter;
            const [mapPos, setMapPos] = useState(data.coords);
            const [zoom, setZoom] = useState(350);
            const [isDragging, setIsDragging] = useState(false);
            const mapRef = useRef(null);
            const lastPos = useRef({ x: 0, y: 0 });
            const lastTouchDist = useRef(0);

            useEffect(() => {
                const mapContainer = mapRef.current;
                const handleWheel = (e) => {
                    e.preventDefault();
                    setZoom(prev => Math.min(Math.max(e.deltaY < 0 ? prev + 40 : prev - 40, 100), 1000));
                };
                const handleTouchMove = (e) => {
                    if (e.touches.length === 2) {
                        e.preventDefault();
                        const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                        if (lastTouchDist.current > 0) {
                            const zoomFactor = dist / lastTouchDist.current;
                            setZoom(prev => Math.min(Math.max(prev * zoomFactor, 100), 1000));
                        }
                        lastTouchDist.current = dist;
                    }
                };
                const handleTouchEnd = () => { lastTouchDist.current = 0; };

                if (mapContainer) {
                    mapContainer.addEventListener("wheel", handleWheel, { passive: false });
                    mapContainer.addEventListener("touchmove", handleTouchMove, { passive: false });
                    mapContainer.addEventListener("touchend", handleTouchEnd);
                }
                return () => {
                    if (mapContainer) {
                        mapContainer.removeEventListener("wheel", handleWheel);
                        mapContainer.removeEventListener("touchmove", handleTouchMove);
                        mapContainer.removeEventListener("touchend", handleTouchEnd);
                    }
                };
            }, []);

            const handleMouseDown = (e) => { setIsDragging(true); lastPos.current = { x: e.clientX, y: e.clientY }; };
            const handleTouchStart = (e) => { 
                if (e.touches.length === 1) { 
                    setIsDragging(true); 
                    lastPos.current = { x: e.touches[0].clientX, y: e.touches[0].clientY }; 
                } 
            };

            const move = (clientX, clientY) => {
                if (!isDragging) return;
                const dx = clientX - lastPos.current.x;
                const dy = clientY - lastPos.current.y;
                const sensitivity = 0.3 * (100 / zoom);
                setMapPos(prev => ({ x: prev.x - dx * sensitivity, y: prev.y - dy * sensitivity }));
                lastPos.current = { x: clientX, y: clientY };
            };

            const handleMapClick = (e) => {
                // If we were just dragging, don't trigger a "click snap"
                if (Math.abs(e.clientX - lastPos.current.x) > 5) return;

                const rect = mapRef.current.getBoundingClientRect();
                const clickX = (e.clientX - rect.left) / rect.width;
                const clickY = (e.clientY - rect.top) / rect.height;

                const zoomFactor = 100 / (zoom / 100);
                const newX = mapPos.x + (clickX - 0.5) * zoomFactor;
                const newY = mapPos.y + (clickY - 0.5) * zoomFactor;

                setMapPos({ x: newX, y: newY });
            };

            const calculateElapsed = (dateStr) => {
                if (dateStr.includes("September 22")) return 0;
                return parseInt(dateStr.split(" ")[1]) - 23;
            };

            const styles = {
                container: { maxWidth: "500px", margin: "0 auto", display: "flex", flexDirection: "column", gap: "25px", padding: "20px" },
                section: { backgroundColor: "#1e1a15", border: "1px solid #3d3329", padding: "15px", borderRadius: "4px" },
                boxLabel: { fontSize: "0.6rem", color: "#8c7a65", textTransform: "uppercase", letterSpacing: "1px", marginBottom: "12px", display: "block" },
                itemLabel: { fontSize: "0.75rem", color: "#c1a45d", marginBottom: "8px", borderBottom: "1px solid #3d3329", paddingBottom: "4px", display: "block" },
                mapContainer: { width: "100%", height: "350px", border: "2px solid #c1a45d", position: "relative", overflow: "hidden", cursor: isDragging ? "grabbing" : "grab", borderRadius: "4px", touchAction: "none" }
            };

            return (
                <div style={styles.container}>
                    <nav className="nav-bar">
                        <span style={{fontSize: '0.65rem', color: '#8c7a65'}}>GO TO:</span>
                        <select defaultValue="" onChange={(e) => { if(e.target.value) window.location.href = e.target.value; }}>
                            <option value="" disabled>Select a Chapter...</option>
                            <optgroup label="FELLOWSHIP OF THE RING">
                                <option value="index.html">Ch 1: A Long-Expected Party</option>
                                <option value="chapter2.html">Ch 2: The Shadow of the Past</option>
                                <option value="chapter3.html">Ch 3: Three Is Company</option>
                                <option value="chapter4.html">Ch 4: A Shortcut to Mushrooms</option>
                                <option value="chapter5.html">Ch 5: A Conspiracy Unmasked</option>
                                <option value="chapter6.html">Ch 6: The Old Forest</option>
                                <option value="chapter7.html">Ch 7: In the House of Tom Bombadil</option>
                                <option value="chapter8.html">Ch 8: Fog on the Barrow-Downs</option>
                                <option value="chapter9.html">Ch 9: At the Sign of the Prancing Pony</option>
                                <option value="chapter10.html">Ch 10: Strider</option>
                                <option value="chapter11.html">Ch 11: A Knife in the Dark</option>
                                <option value="chapter12.html">Ch 12: Flight to the Ford</option>
                            </optgroup>
                        </select>
                    </nav>

                    <header style={{ textAlign: "center", borderBottom: "1px solid #3d3329", paddingBottom: "15px" }}>
                        <div style={{ fontSize: "0.8rem", color: "#8c7a65", letterSpacing: "2px" }}>{CHAPTER_DATA.bookTitle}</div>
                        <h1 style={{ fontSize: "1.4rem", color: "#f2e6d0" }}>Chapter {data.number}: {data.title}</h1>
                    </header>

                    <section style={styles.section}>
                        <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: "10px" }}>
                            <span style={styles.boxLabel}>Location: {data.location}</span>
                            <div style={{display: 'flex', alignItems: 'center', gap: '8px'}}>
                                <small style={{fontSize: '0.6rem', color: '#8c7a65'}}>ZOOM</small>
                                <input type="range" min="100" max="1000" value={zoom} onChange={(e) => setZoom(Number(e.target.value))} />
                            </div>
                        </div>
                        <div 
                            ref={mapRef}
                            style={styles.mapContainer} 
                            onMouseDown={handleMouseDown} 
                            onMouseMove={(e) => move(e.clientX, e.clientY)} 
                            onMouseUp={(e) => { setIsDragging(false); handleMapClick(e); }} 
                            onMouseLeave={() => setIsDragging(false)}
                            onTouchStart={handleTouchStart}
                            onTouchMove={(e) => { if (e.touches.length === 1) move(e.touches[0].clientX, e.touches[0].clientY); }}
                            onTouchEnd={() => setIsDragging(false)}
                        >
                            <div style={{
                                width: "100%", height: "100%",
                                backgroundImage: "url('https://i.redd.it/r8403tg0wo5c1.jpeg')",
                                backgroundSize: `${zoom}%`,
                                backgroundPosition: `${mapPos.x}% ${mapPos.y}%`,
                                backgroundRepeat: "no-repeat",
                                transition: isDragging ? "none" : "background-position 0.3s ease-out"
                            }}></div>

                            {/* TARGET RETICLE */}
                            <div style={{
                                position: 'absolute', top: '50%', left: '50%',
                                width: '20px', height: '20px',
                                border: '2px solid #ff4444', borderRadius: '50%',
                                transform: 'translate(-50%, -50%)',
                                pointerEvents: 'none', boxShadow: '0 0 10px rgba(0,0,0,0.8)',
                                zIndex: 5
                            }}>
                                <div style={{ position: 'absolute', top: '50%', left: '0', width: '100%', height: '1px', backgroundColor: '#ff4444' }}></div>
                                <div style={{ position: 'absolute', left: '50%', top: '0', width: '1px', height: '100%', backgroundColor: '#ff4444' }}></div>
                            </div>

                            {/* COORDINATE TRACKER */}
                            <div style={{
                                position: 'absolute', bottom: '10px', right: '10px',
                                backgroundColor: 'rgba(0,0,0,0.8)', color: '#c1a45d',
                                padding: '4px 8px', fontSize: '0.7rem', borderRadius: '4px',
                                pointerEvents: 'none', border: '1px solid #c1a45d', zIndex: 10
                            }}>
                                TARGET X: {mapPos.x.toFixed(1)}% | Y: {mapPos.y.toFixed(1)}%
                            </div>
                        </div>
                        <div style={{textAlign: 'center', marginTop: '8px'}}>
                            <small style={{fontSize: '0.6rem', color: '#8c7a65'}}>Click map to center on specific pixel</small>
                        </div>
                    </section>

                    <section style={styles.section}>
                        <span style={styles.boxLabel}>Visual Gallery</span>
                        {data.illustrations.map((item, idx) => (
                            <div key={idx} style={{ marginBottom: "20px" }}>
                                <span style={styles.itemLabel}>{item.label}</span>
                                <img src={item.url} style={{ width: "100%", borderRadius: "2px" }} alt={item.label} />
                            </div>
                        ))}
                    </section>

                    <section style={styles.section}>
                        <span style={styles.boxLabel}>Songs & Poems</span>
                        {data.videos.map((item, idx) => (
                            <div key={idx} style={{ marginBottom: "20px" }}>
                                <span style={styles.itemLabel}>{item.label}</span>
                                <iframe width="100%" height="200" src={`https://www.youtube.com/embed/${item.id}`} style={{ border: "none" }} allowFullScreen></iframe>
                            </div>
                        ))}
                    </section>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<LOTRCompanion />);
    </script>
</body>
</html>
